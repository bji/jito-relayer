name: Clean Code Check
on:
  workflow_call:
    secrets:
      GHUB_TOKEN:
        required: true

jobs:
  clippy_and_udeps_check:
    runs-on: big-runner-1
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Install Protobuf
        run: |
          export PROTOC_VERSION=21.12 && \
          export PROTOC_ZIP=protoc-$PROTOC_VERSION-linux-x86_64.zip && \
          curl -Ss -OL https://github.com/google/protobuf/releases/download/v$PROTOC_VERSION/$PROTOC_ZIP \
          && sudo unzip -o $PROTOC_ZIP -d /usr/local bin/protoc \
          && sudo unzip -o $PROTOC_ZIP -d /usr/local include/* \
          && rm -f $PROTOC_ZIP

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check rust version before
        run: |
          rustc --version || true;
          cargo --version || true;
          cargo clippy --version || true;
          cargo fmt --version || true;

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: clippy

      - name: Check rust version after
        run: |
          rustc --version;
          cargo --version;
          cargo clippy --version;
          cargo fmt --version;

#
#      - uses: actions-rs/clippy-check@v1
#        with:
#          args: --all-features

      - uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-udeps --locked

      - name: cargo udeps
        uses: actions-rs/cargo@v1
        with:
          command: udeps
